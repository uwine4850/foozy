<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>Auth - foozy</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Auth";
        var mkdocs_page_input_path = "builtin/auth/auth.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> foozy
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">General</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../getting_started/">Getting started</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Cmd and config</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../cmd_and_config/cmd/">Cmd</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../cmd_and_config/config/">Config</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Router</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../router/router/">Router</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../router/websocket/">Websocket</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../router/cookies/cookies/">Cookies</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../router/manager/manager/">Manager</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../router/form/form/">Form</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../router/middlewares/middlewares/">Middlewares</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../router/object/object/">Object</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../router/rest/rest/">Rest</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../router/tmlengine/tmlengine/">Tmlengine</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Secure</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../secure/csrf_token/">CSRF token</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../secure/hmac/">HMAC</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../secure/jwt/">JWT</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../secure/key/">Key</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../secure/header/">Header</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Database</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../database/database/">Database</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../database/async_queries/">AsyncQueries</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../database/sync_queries/">SyncQueries</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../database/database_pool/">DatabasePool</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Codegen</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../codegen/gen/">Gen</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Debug</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../debug/logging/">Logging</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Mapper</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../mapper/mapper/">Mapper</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Builtin</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../builtin/">Builtin</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Typeopr</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../typeopr/typeopr/">Typeopr</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Server</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../server/server/">Server</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../server/globalflow/globalflow/">Globalflow</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../server/livereload/livereload/">Livereload</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Utils</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../utils/fmap/fmap/">fmap</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../utils/fpath/fpath/">fpath</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../utils/fslice/fslice/">fslice</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../utils/fstring/fstring/">fstring</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../utils/fstruct/fstruct/">fstruct</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">foozy</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Auth</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h2 id="auth">auth</h2>
<p>This package is designed for full interaction with the user account.</p>
<p>More detailed information on how to use this package can be found in the <a href="https://github.com/uwine4850/foozy/blob/master/tests/auth_test/auth_test.go">tests</a>.</p>
<h3 id="authquery-interface">AuthQuery interface</h3>
<p>Interface is designed to abstract from the database during authentication.<br>
Any database can implement this interface and use it in the auth package.</p>
<h4 id="authqueryuserbyusername">AuthQuery.UserByUsername</h4>
<p>With username returns an <a href="#unsafeuser">UnsafeUser</a> object that stores user data from the database.</p>
<pre><code class="language-golang">UserByUsername(username string) (*UnsafeUser, error)
</code></pre>
<h4 id="authqueryuserbyid">AuthQuery.UserById</h4>
<p>With id returns an <a href="#unsafeuser">UnsafeUser</a> object that stores user data from the database.</p>
<pre><code class="language-golang">UserById(id any) (*UnsafeUser, error)
</code></pre>
<h4 id="authquerycreatenewuser">AuthQuery.CreateNewUser</h4>
<p>Creates a new user in the database.<br>
The password must be encrypted in advance before passing it to this method.</p>
<pre><code class="language-golang">CreateNewUser(username string, hashPassword string) (result map[string]interface{}, err error)
</code></pre>
<h4 id="authquerychangepassword">AuthQuery.ChangePassword</h4>
<p>Changes the user's password.<br>
The password must be encrypted in advance before passing it to this method.</p>
<pre><code class="language-golang">ChangePassword(userId string, newHashPassword string) (result map[string]interface{}, err error)
</code></pre>
<h3 id="unsafeuser">UnsafeUser</h3>
<p>Full user data.<br>
Not safe, should be used with caution.</p>
<pre><code class="language-golang">type UnsafeUser struct {
    Id       int    `db:&quot;id&quot;`
    Username string `db:&quot;username&quot;`
    Password string `db:&quot;password&quot;`
}
</code></pre>
<h3 id="user">User</h3>
<p>Public user data that can be accessed by everyone.</p>
<pre><code class="language-golang">type User struct {
    Id       int    `db:&quot;id&quot;`
    Username string `db:&quot;username&quot;`
}
</code></pre>
<h3 id="cookie">Cookie</h3>
<p>Presentation of authentication cookies.</p>
<pre><code class="language-golang">type Cookie struct {
    UID     int
    KeyDate time.Time
}
</code></pre>
<h3 id="jwtclaims">JWTClaims</h3>
<p>Claims for JWT authentication.</p>
<pre><code class="language-golang">type JWTClaims struct {
    jwt.RegisteredClaims
    Id int `json:&quot;id&quot;`
}
</code></pre>
<h3 id="auth_1">Auth</h3>
<p>Structure is designed to manage user authentication.<br>
It can be used to create a user, check the correctness of the login data, change the password and
check the availability of the user.</p>
<h4 id="authregisteruser">Auth.RegisterUser</h4>
<p>Registers the user in the database.<br>
It also checks the password and makes sure that there is no user with that login.&lt;br
Returns the ID of the new user.</p>
<pre><code class="language-golang">func (a *Auth) RegisterUser(username string, password string) (userId int, err error) {
    user, err := a.db.UserByUsername(username)
    if err != nil {
        return 0, err
    }
    if user != nil {
        return 0, ErrUserAlreadyExist{username}
    }
    if len(password) &lt; 6 {
        return 0, ErrShortPassword{}
    }
    if len(username) &lt; 3 {
        return 0, ErrShortUsername{}
    }
    hashPass, err := HashPassword(password)
    if err != nil {
        return 0, err
    }
    result, err := a.db.CreateNewUser(username, hashPass)
    if err != nil {
        return 0, err
    }
    insertUserId, ok := result[&quot;insertID&quot;].(int64)
    if !ok {
        return 0, &amp;ErrUserRegistration{}
    }
    return int(insertUserId), nil
}
</code></pre>
<h4 id="authloginuser">Auth.LoginUser</h4>
<p>Check if the password and login are the same.<br>
If there was no error returns an <a href="#user">User</a> object with user data.</p>
<pre><code class="language-golang">func (a *Auth) LoginUser(username string, password string) (*User, error) {
    user, err := a.db.UserByUsername(username)
    if err != nil {
        return nil, err
    }
    if user == nil {
        return nil, ErrUserNotExist{username}
    }
    err = ComparePassword(user.Password, password)
    if err != nil {
        return nil, err
    }
    return &amp;User{
        user.Id,
        user.Username,
    }, nil
}
</code></pre>
<h4 id="authupdateauthcookie">Auth.UpdateAuthCookie</h4>
<p>Updates the cookie encoding.<br>
<strong>IMPORTANT</strong>: to work, you need to decode the data; accordingly, in the hashKey and blockKey fields you need to use the keys with which they were encoded.<br> Next, the function itself will take new keys from ManagerConf.</p>
<pre><code class="language-golang">func (a *Auth) UpdateAuthCookie(hashKey []byte, blockKey []byte, r *http.Request) error {
    var authCookie Cookie
    if err := cookies.ReadSecureCookieData(hashKey, blockKey, r, namelib.AUTH.COOKIE_AUTH, &amp;authCookie); err != nil {
        return err
    }
    if err := a.AddAuthCookie(authCookie.UID); err != nil {
        return err
    }
    return nil
}
</code></pre>
<h4 id="authaddauthcookie">Auth.AddAuthCookie</h4>
<p>Adds the user's authentication cipher to the cookie.</p>
<pre><code class="language-golang">func (a *Auth) AddAuthCookie(uid int) error {
    k := a.manager.Key().Get32BytesKey()
    if err := cookies.CreateSecureCookieData([]byte(k.HashKey()), []byte(k.BlockKey()), a.w, &amp;http.Cookie{
        Name:     namelib.AUTH.COOKIE_AUTH,
        Path:     &quot;/&quot;,
        HttpOnly: true,
        Secure:   true,
    }, &amp;Cookie{UID: uid, KeyDate: a.manager.Key().Get32BytesKey().Date()}); err != nil {
        return err
    }
    authDate := a.manager.Key().Get32BytesKey().Date()
    if err := cookies.CreateSecureNoHMACCookieData([]byte(k.StaticKey()), a.w, &amp;http.Cookie{
        Name:     namelib.AUTH.COOKIE_AUTH_DATE,
        Path:     &quot;/&quot;,
        HttpOnly: true,
        Secure:   true,
    }, &amp;authDate); err != nil {
        return err
    }
    return nil
}
</code></pre>
<h4 id="authchangepassword">Auth.ChangePassword</h4>
<p>Changes the current user password.</p>
<pre><code class="language-golang">func (a *Auth) ChangePassword(username string, oldPassword string, newPassword string) error {
    user, err := a.db.UserByUsername(username)
    if err != nil {
        return err
    }
    if user == nil {
        return ErrUserNotExist{username}
    }
    if len(newPassword) &lt; 6 {
        return ErrShortPassword{}
    }
    err = ComparePassword(user.Password, oldPassword)
    if err != nil {
        return err
    }
    password, err := HashPassword(newPassword)
    if err != nil {
        return err
    }
    if _, err := a.db.ChangePassword(username, password); err != nil {
        return err
    }
    return nil
}
</code></pre>
<h4 id="userbyusername">UserByUsername</h4>
<p>Checks if the user is in the database.<br>
If it is found, it returns information about it.</p>
<pre><code class="language-golang">func UserByUsername(db AuthQuery, username string) (*User, error) {
    user, err := db.UserByUsername(username)
    if err != nil {
        return nil, err
    }
    return &amp;User{
        Id:       user.Id,
        Username: user.Username,
    }, nil
}
</code></pre>
<h4 id="userbyid">UserByID</h4>
<p>Searches for a user by ID and returns it.</p>
<pre><code class="language-golang">func UserByID(db AuthQuery, id any) (*User, error) {
    user, err := db.UserById(id)
    if err != nil {
        return nil, err
    }
    return &amp;User{
        Id:       user.Id,
        Username: user.Username,
    }, nil
}
</code></pre>
<h4 id="createmysqlauthtable">CreateMysqlAuthTable</h4>
<p>Creates a user authentication table.</p>
<pre><code class="language-golang">func CreateMysqlAuthTable(dbInteraction interfaces.DatabaseInteraction, databaseName string) error {
    sql := fmt.Sprintf(&quot;CREATE TABLE IF NOT EXISTS `%s`.`%s` &quot;+
        &quot;(`id` INT NOT NULL AUTO_INCREMENT , &quot;+
        &quot;`username` VARCHAR(200) NOT NULL , &quot;+
        &quot;`password` TEXT NOT NULL , PRIMARY KEY (`id`))&quot;, databaseName, namelib.AUTH.AUTH_TABLE)
    _, err := dbInteraction.SyncQ().Query(sql)
    if err != nil {
        return err
    }
    return nil
}
</code></pre>
<h4 id="hashpassword">HashPassword</h4>
<p>Generating a password hash from a string.</p>
<pre><code class="language-golang">func HashPassword(password string) (string, error) {
    bytesPass := []byte(password)
    fromPassword, err := bcrypt.GenerateFromPassword(bytesPass, bcrypt.DefaultCost)
    if err != nil {
        return &quot;&quot;, err
    }
    return string(fromPassword), nil
}
</code></pre>
<h4 id="comparepassword">ComparePassword</h4>
<p>Check if the password hash and the password itself match.</p>
<pre><code class="language-golang">func ComparePassword(hashedPassword string, password string) error {
    err := bcrypt.CompareHashAndPassword([]byte(hashedPassword), []byte(password))
    if err != nil {
        return ErrPasswordsDontMatch{}
    }
    return nil
}
</code></pre>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../..";</script>
    <script src="../../../js/theme_extra.js"></script>
    <script src="../../../js/theme.js"></script>
      <script src="../../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
